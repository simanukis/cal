<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>営業車両予約</title>
    <script src="assets/js/index.global.js"></script>
    <script src="packages/core/locales/ja.global.min.js"></script>
    <script src="packages/bootstrap5/index.global.js"></script>

    <!-- the connector. must go AFTER moment-timezone -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/moment-timezone@6.1.8/index.global.min.js"></script> -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');

            var calendar = new FullCalendar.Calendar(calendarEl, {
                headerToolbar: {
                    // fullcalendarのヘッダーに配置するボタン
                    // 左側には「前月、翌月、今日」のボタン
                    // 中央には表示している月
                    // 右側には月表示、週表示、日表示、月予定
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth',
                },
                initialDate: '2023-07-12',
                locale: "locale",
                timeZone: 'local',
                eventDisplay: 'block',
                displayEventTime: false,

                dayCellContent: function(arg) {
                    return arg.date.getDate();
                },

                navLinks: true, // カレンダー内の日付クリックで日表示に遷移するかどうか
                businessHours: true, // 土日色付け
                editable: true,

                selectable: true, // 日付をクリック、または範囲を選択したイベント
                select: function(arg) {
                    initEditModal(arg);
                },
                eventClick: arg => {
                    // カレンダーに設定したイベントクリック時のイベント
                    console.log(arg);
                    initEditModal(arg);
                },

                slotDuration: '00:15:00',
                slotLabelInterval: '01:00',

                editable: true, // 編集可能設定
                slotEventOverlap: true, // イベントの見た目を重ねて表示
                selectMinDistance: 1, // selectMinDistanceに設定した間を超えたらドラッグイベントで扱う

                eventContent: function(arg) {
                    // イベント（予定）毎の初期化処理
                },

                eventDrop: function(event, delta, revertFunc, jsEvent, ui, view) {
                    // イベントをドラッグして別日に移動させた時のイベント
                },

                events: [{
                        title: 'Business Lunch',
                        start: '2023-07-03T13:00:00',
                        constraint: 'businessHours'
                    }, {
                        title: 'Meeting',
                        start: '2023-07-13T11:00:00',
                        constraint: 'availableForMeeting', // defined below
                        color: '#257e4a'
                    }, {
                        title: 'Conference',
                        start: '2023-07-18',
                        end: '2023-07-20'
                    }, {
                        title: 'Party',
                        start: '2023-07-29T20:00:00'
                    },

                    // areas where "Meeting" must be dropped
                    {
                        groupId: 'availableForMeeting',
                        start: '2023-07-11T10:00:00',
                        end: '2023-07-11T16:00:00',
                        display: 'background'
                    }, {
                        groupId: 'availableForMeeting',
                        start: '2023-07-13T10:00:00',
                        end: '2023-07-13T16:00:00',
                        display: 'background'
                    },

                    // red areas where no events can be dropped
                    {
                        start: '2023-07-24',
                        end: '2023-07-28',
                        overlap: false,
                        display: 'background',
                        color: '#ff9f89'
                    }, {
                        start: '2023-07-06',
                        end: '2023-07-08',
                        overlap: false,
                        display: 'background',
                        color: '#ff9f89'
                    }
                ]
            });
            calendar.render();
        });

        const initEditModal = data => {
            removeAlreadyModal();
            const defModal = document.getElementById('modal-template');
            const modal = defModal.cloneNode(true);
            modal.id = 'modal';

            setupModalPosition(modal, data.jsEvent);
            document.body.appendChild(modal);
            if (data.event === undefined) {
                document.querySelector('#modal .delete').remove();
            }
            setupModalData(modal, data);

            registerEditModalEvent(modal, data);
        };

        const setupModalPosition = (modal, e) => {
            modal.style.display = 'flex';
            modal.style.position = 'absolute';
            modal.style.zIndex = 9999;

            const position = calcModalPosition(e);
            modal.style.left = `${position.x}px`;
            modal.style.top = `${position.y}px`;
        };

        const calcModalPosition = e => {
            const windowWidth = window.outerWidth;

            const y = e.pageY + 16;
            let x = e.pageX;

            if (e.pageX <= 125) {
                x = e.pageX;
            } else if (e.pageX > 125 && windowWidth - e.pageX > 125) {
                x = e.pageX - 125;
            } else if (windowWidth - e.pageX <= 125) {
                x = e.pageX - 250;
            }

            return {
                x: x,
                y: y
            };
        };
        const removeAlreadyModal = () => {
            const modal = document.getElementById('modal');
            if (modal) {
                modal.remove();
            }
        };

        // モーダル登録処理
        const registerEditModalEvent = (modal, arg) => {
            const start = modal.querySelector('#start');
            const end = modal.querySelector('#end');
            const title = modal.querySelector('#title');
            const color = modal.querySelector('#color');

            // 保存
            const saveButton = modal.querySelector('#save');
            if (saveButton) {
                saveButton.addEventListener('click', e => {
                    e.preventDefault();

                    if (arg.event !== undefined) {
                        // 変更時
                        const endStrings = end.value && start.value !== end.value ? end.value.split('-') : start.value.split('-');
                        const endDate = new Date(endStrings[0], parseInt(endStrings[1]) - 1, endStrings[2], 23, 59, 59);

                        arg.event.setStart(start.value);
                        arg.event.setEnd(endDate);
                        arg.event.setProp('title', title.value);
                        arg.event.setProp('backgroundColor', color.value);
                    } else {
                        // 新規作成時
                        const endStrings = end.value && start.value !== end.value ? end.value.split('-') : start.value.split('-');
                        const endDate = new Date(endStrings[0], parseInt(endStrings[1]) - 1, endStrings[2], 23, 59, 59);

                        calendar.addEvent({
                            start: start.value,
                            end: endDate,
                            title: title.value,
                            backgroundColor: color.value
                        });
                    }
                    calendar.unselect();
                    modal.remove();
                });
            }

            // キャンセル
            const cancelButton = modal.querySelector('#cancel');
            cancelButton.addEventListener('click', e => {
                e.preventDefault();

                calendar.unselect();
                modal.remove();
            });

            // 削除
            const deleteButton = modal.querySelector('#delete');
            if (deleteButton) {

                deleteButton.addEventListener('click', e => {
                    e.preventDefault();
                    arg.event.remove();
                    calendar.unselect();
                    modal.remove();
                });
            }
        };

        // モダールに既存イベントを設定
        const setupModalData = (modal, data) => {
            const start = modal.querySelector('#start');
            const end = modal.querySelector('#end');
            const title = modal.querySelector('#title');
            const color = modal.querySelector('#color');

            console.log(data);
            if (data.event !== undefined) {
                start.value = /T/.test(data.event.startStr) ? data.event.startStr.split('T')[0] : data.event.startStr;
                end.value = /T/.test(data.event.endStr) ? data.event.endStr.split('T')[0] : data.event.endStr;
                title.value = data.event.title;
                color.value = data.event.backgroundColor;
            } else {
                start.value = data.startStr;

                const diffTime = Math.abs(data.end - data.start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (1 < diffDays) {

                    const endDate = data.end;
                    endDate.setDate(endDate.getDate() - 1);
                    end.value = formatDate(endDate);
                }
            }
        };

        // DateObject to YYYY-MM-DD
        function formatDate(date) {
            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();

            if (month.length < 2)
                month = '0' + month;
            if (day.length < 2)
                day = '0' + day;

            return [year, month, day].join('-');
        }
    </script>
    <style>
        body {
            margin: 40px 10px;
            padding: 0;
            font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
            font-size: 14px;
        }
        
        #calendar {
            max-width: 1100px;
            margin: 0 auto;
        }
    </style>
</head>

<body>
    <div id="calendar"></div>
    <div class="modal" id="modal-template">
        <div class="modal__title">
            <label>タイトル： <input type="text" id="title"></label>
        </div>
        <div class="modal__color">
            <label>背景色： <input type="color" id="color"></label>
        </div>
        <div class="modal__times">
            <label>開始： <input type="date" id="start"></label>
            <label>終了： <input type="date" id="end"></label>
        </div>
    </div>
</body>

</html>